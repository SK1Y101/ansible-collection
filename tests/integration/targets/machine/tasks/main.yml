---
- environment:
    MAAS_HOST: "{{ host }}"
    MAAS_TOKEN_KEY: "{{ token_key }}"
    MAAS_TOKEN_SECRET: "{{ token_secret }}"
    MAAS_CUSTOMER_KEY: "{{ customer_key }}"


  block:
    - name: Delete machine
      canonical.maas.instance:
        fqdn: machine-test.maas
        state: absent

    - name: Add machine.
      canonical.maas.machine:
        power_type: lxd
        power_parameters:
          power_address: 172.16.117.70:8443
          instance_name: kdobivedu
        pxe_mac_address: 00:00:00:00:00:02
        hostname: machine-test
      register: machine
    - ansible.builtin.assert:
        that:
          - machine is changed
          - machine.record.hostname == "machine-test"
          - machine.record.power_type == "lxd"
          - machine.record.network_interfaces.0.mac_address == 00:00:00:00:00:02

    - name: Delete machine
      canonical.maas.instance:
        fqdn: machine-test.maas
        state: absent
