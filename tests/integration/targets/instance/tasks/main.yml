---
- environment:
    MAAS_HOST: "{{ host }}"
    MAAS_TOKEN_KEY: "{{ token_key }}"
    MAAS_TOKEN_SECRET: "{{ token_secret }}"
    MAAS_CLIENT_KEY: "{{ client_key }}"


  block:
  - name: Delete machine
    canonical.maas.instance:
      hostname: instance_test
      state: absent

  - name: Create virtual machine with two disks and a network interface.
    canonical.maas.vm_host_machine:
      hostname: instance_test
      vm_host: sunny-raptor
      cores: 2
      memory: 2000
      network_interfaces:
        name: my_first
        subnet_cidr: "10.10.10.0/24"
      storage_disks:
        - size_gigabytes: 8
    register: initial_machine
  - ansible.builtin.assert:
      that:
        - initial_machine is changed
        - initial_machine.record.hostname == "instance_test"
        - initial_machine.record.memory == 2000
        - initial_machine.record.cores == 2

  - name: Deploy machine
    canonical.maas.instance:
      hostname: instance_test
      state: deployed
    register: machine
  - ansible.builtin.assert:
      that:
        - machine is changed
        - machine.record.hostname == "instance_test"
        - machine.record.memory == 2048
        - machine.record.cores == 2
        - machine.record.osystem == "ubuntu"
        - machine.record.distro_series == "focal"
        - machine.record.status == "Deployed"
    
  - name: Deploy machine - idempotence
    canonical.maas.instance:
      hostname: instance_test
      state: deployed
    register: machine
  - ansible.builtin.assert:
      that:
        - machine is not changed
        - machine.record.hostname == "instance_test"
        - machine.record.memory == 2048
        - machine.record.cores == 2
        - machine.record.osystem == "ubuntu"
        - machine.record.distro_series == "focal"
        - machine.record.status == "Deployed"
  
  - name: Release machine
    canonical.maas.instance:
      hostname: instance_test
      state: ready
    register: machine
  - ansible.builtin.assert:
      that:
        - machine is changed
        - machine.record.hostname == "instance_test"
        - machine.record.memory == 2048
        - machine.record.cores == 2
        - machine.record.status == "Ready"
  
  - name: Release machine - idempotence
    canonical.maas.instance:
      hostname: instance_test
      state: ready
    register: machine
  - ansible.builtin.assert:
      that:
        - machine is not changed
        - machine.record.hostname == "instance_test"
        - machine.record.memory == 2048
        - machine.record.cores == 2
        - machine.record.status == "Ready"
  
  - name: Deploy machine with another OS
    canonical.maas.instance:
      hostname: instance_test
      state: deployed
      deploy_params:
        osystem: ubuntu
        distro_series: jammy
    register: machine
  - ansible.builtin.assert:
      that:
        - machine is changed
        - machine.record.hostname == "instance_test"
        - machine.record.memory == 2048
        - machine.record.cores == 2
        - machine.record.osystem == "ubuntu"
        - machine.record.distro_series == "jammy"
        - machine.record.status == "Deployed"

  - name: Release machine
    canonical.maas.instance:
      hostname: instance_test
      state: ready
    register: machine
  - ansible.builtin.assert:
      that:
        - machine is changed
        - machine.record.hostname == "instance_test"
        - machine.record.memory == 2048
        - machine.record.cores == 2
        - machine.record.status == "Ready"
  
  - name: Delete machine
    canonical.maas.instance:
      hostname: instance_test
      state: absent
    register: machine
  - ansible.builtin.assert:
      that:
        - machine is changed
  
  - name: Delete machine - idempotence
    canonical.maas.instance:
      hostname: instance_test
      state: absent
    register: machine
  - ansible.builtin.assert:
      that:
        - machine is not changed

  - name: Deploy new machine with default OS and allocation constraints
    canonical.maas.instance:
      state: deployed
    register: machine
  - ansible.builtin.assert:
      that:
        - machine is changed
        - machine.record.memory == 2048
        - machine.record.cores == 1
        - machine.record.osystem == "ubuntu"
        - machine.record.distro_series == "focal"
        - machine.record.status == "Deployed"
  
  - name: Release machine (ephemeral machine is deleted)
    canonical.maas.instance:
      hostname: "{{ machine.record.hostname }}"
      state: ready
    register: machine
  - ansible.builtin.assert:
      that:
        - machine is changed

  - name: Deploy new machine with custom OS and allocation constraints
    canonical.maas.instance:
      state: deployed
      allocate_params:
        cores: 3
        memory: 2000
      deploy_params:
        osystem: ubuntu
        distro_series: jammy
    register: machines
  - ansible.builtin.assert:
      that:
        - machine is changed
        - machine.record.memory == 2048
        - machine.record.cores == 3
        - machine.record.osystem == "ubuntu"
        - machine.record.distro_series == "jammy"
        - machine.record.status == "Deployed"
  
  - name: Release machine (ephemeral machine is deleted)
    canonical.maas.instance:
      hostname: awake-raven
      #hostname: "{{ machine.record.hostname }}"
      state: ready
    register: machine
  - ansible.builtin.assert:
      that:
        - machine is changed

  - name: Deploy new machine with constraints that can't be meet
    canonical.maas.instance:
      state: deployed
      allocate_params:
        cores: 20
        memory: 2000
      deploy_params:
        osystem: ubuntu
        distro_series: jammy
    register: machine
    ignore_errors: true
  - ansible.builtin.assert:
      that:
        - machine is failed
        - machine is not changed
        - "'No available machine matches constraints' in machine.msg"
